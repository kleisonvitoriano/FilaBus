<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fila Virtual (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/Design sem nome.png">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            color: #0f172a;
        }
        .dark body { 
            background-color: #020617;
            color: #f1f5f9;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            z-index: 1000;
            transition: top 0.4s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #toast.show { top: 20px; }
        #toast.success { background-color: #22c55e; }
        #toast.error { background-color: #ef4444; }
        #toast.info { background-color: #3b82f6; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(10, 10, 20, 0.7);
            backdrop-filter: blur(4px);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

         #auth-overlay{
          background-image: url("assets/Design\ sem\ nome.png");
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
        }
        @media (max-width: 640px) {
          #auth-overlay{
            background-image: url("assets/Design\ sem\ nome.png");
            background-size: cover;
            background-position: 40%;
            background-repeat: no-repeat;
          }

    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="container mx-auto max-w-md pb-28">
        
        <div id="toast"></div>

        <div id="loading-section" class="flex items-center justify-center h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
        </div>

        <!-- Ecr√£ de Autentica√ß√£o (Login/Registo) -->
        <div id="auth-overlay" class="hidden fixed inset-0 bg-slate-100 dark:bg-slate-900 z-40 flex items-center justify-center p-4 ">
            <div id="auth-section" class="w-full bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-2xl space-y-4 fade-in">
                <div id="auth-tabs" class="flex border-b border-slate-200 dark:border-slate-700">
                    <button id="show-login-tab" class="flex-1 pb-2 text-center font-semibold border-b-2 border-indigo-500 text-indigo-500">Entrar</button>
                    <button id="show-register-tab" class="flex-1 pb-2 text-center font-semibold text-slate-500 dark:text-slate-400">Registar</button>
                </div>
                <div id="login-form" class="">
                    <input type="email" id="loginEmail" placeholder="E-mail" class="mb-4 w-full bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4" autocomplete="email">
                    <input type="password" id="loginPassword" placeholder="Palavra-passe" class="mb-2 w-full bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4" autocomplete="current-password">
                    <div class="flex justify-between items-center mb-4 px-1">
                        <label class="flex items-center text-sm text-slate-600 dark:text-slate-300">
                            <input type="checkbox" id="rememberMe" class="rounded border-slate-300 text-indigo-500 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <span class="ml-2">Manter-me conectado</span>
                        </label>
                        <button id="forgot-password-link" class="text-sm text-indigo-500 hover:underline">Esqueceu a senha?</button>
                    </div>
                    <button id="login-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl transition">Entrar</button>
                </div>
                <div id="register-form" class="hidden">
                    <input type="email" id="registerEmail" placeholder="E-mail" class="mb-4 w-full bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4" autocomplete="email">
                    <input type="password" id="registerPassword" placeholder="Palavra-passe (m√≠n. 6 caracteres)" class="mb-4 w-full bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4" autocomplete="new-password">
                    <input type="password" id="registerPasswordConfirm" placeholder="Confirmar Palavra-passe" class="mb-4 w-full bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4" autocomplete="new-password">
                    <button id="register-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition">Criar Conta</button>
                </div>
                 <div id="password-reset-form" class="hidden">
                    <h3 class="text-lg font-bold text-center text-slate-900 dark:text-white mb-2">Recuperar Senha</h3>
                    <p class="text-sm text-center text-slate-600 dark:text-slate-400 mb-4">Insira o seu e-mail para receber um link de redefini√ß√£o.</p>
                    <input type="email" id="resetEmail" placeholder="E-mail de registo" class="mb-4 w-full bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4" autocomplete="email">
                    <button id="send-reset-email-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl transition">Enviar E-mail</button>
                     <button id="back-to-login-btn" class="w-full text-center mt-3 text-sm text-slate-500 hover:underline">Voltar para o Login</button>
                </div>
                <p id="auth-error" class="text-red-500 text-center text-sm min-h-[20px]"></p>
            </div>
        </div>

        <!-- Ecr√£ de Completar/Editar Perfil -->
        <div id="profile-overlay" class="hidden fixed inset-0 bg-slate-100 dark:bg-slate-900 z-50 p-4 overflow-y-auto">
            <div class="w-full max-w-md mx-auto space-y-6 fade-in pt-10">
                <div class="flex justify-between items-center">
                    <h2 id="profile-title" class="text-2xl font-bold text-slate-900 dark:text-white"></h2>
                    <button id="close-profile-btn" class="text-slate-500 hover:text-slate-800 dark:hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                <div class="flex flex-col items-center space-y-4">
                    <img id="profile-pic-preview" class="w-32 h-32 rounded-full object-cover border-4 border-slate-200 dark:border-slate-700">
                </div>

                <input type="text" id="userName" placeholder="Nome Completo" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-xl py-3 px-4">
                <input type="text" id="userCourse" placeholder="Curso" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-xl py-3 px-4">
                <input type="tel" id="userPhone" placeholder="Telem√≥vel (Opcional)" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-xl py-3 px-4">
                <button id="save-profile-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl transition">Guardar Altera√ß√µes</button>
            </div>
        </div>
        
        <!-- Ecr√£ de Sele√ß√£o de Fila -->
        <div id="queue-selection-screen" class="hidden p-4 space-y-6 fade-in">
            <h1 class="text-3xl font-bold text-center mt-8">Filas Dispon√≠veis</h1>
            <div id="queues-list" class="space-y-3"></div>
            <div class="space-y-3 pt-4">
                <button id="join-new-queue-btn" class="w-full bg-slate-700 hover:bg-slate-800 dark:bg-slate-200 dark:hover:bg-slate-300 text-white dark:text-slate-900 font-bold py-3 px-4 rounded-xl transition">Entrar numa Fila por C√≥digo</button>
                <button id="create-new-queue-btn" class="hidden w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl transition">Criar Nova Fila</button>
                <button id="main-logout-btn" class="w-full text-center mt-3 text-sm text-red-500 hover:underline">Sair da Conta</button>
            </div>
        </div>

        <!-- Ecr√£ Principal da Fila -->
        <div id="main-content" class="hidden p-4 space-y-6 fade-in">
            <header class="flex justify-between items-center">
                <div>
                     <button id="back-to-selection-btn" class="flex items-center gap-1 text-sm text-slate-500 hover:text-indigo-500 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        Voltar
                    </button>
                    <h1 id="header-queue-name" class="text-2xl font-bold text-slate-900 dark:text-white">Nome da Fila</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button id="edit-profile-btn" class="text-slate-500 hover:text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <img id="header-user-avatar" class="w-12 h-12 rounded-full object-cover">
                    <button id="header-leave-queue-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition-all text-sm">Sair</button>
                </div>
            </header>

            <div id="super-admin-panel" class="hidden bg-amber-100 dark:bg-amber-800/20 p-5 rounded-2xl space-y-3">
                <h2 class="text-lg font-bold text-center text-amber-800 dark:text-amber-300">Painel Super Admin</h2>
                 <p class="text-xs text-center text-amber-700 dark:text-amber-400 -mt-2">C√≥digo da Fila: <strong id="queue-code-display"></strong></p>
                <div class="grid grid-cols-2 gap-2 items-center">
                     <label for="queueOpenTime" class="text-sm font-medium">Abre √†s:</label>
                     <input type="time" id="queueOpenTime" class="w-full bg-white/70 dark:bg-slate-700 rounded-lg p-2 text-sm text-slate-900 dark:text-white">
                     <label for="queueCloseTime" class="text-sm font-medium">Fecha √†s:</label>
                     <input type="time" id="queueCloseTime" class="w-full bg-white/70 dark:bg-slate-700 rounded-lg p-2 text-sm text-slate-900 dark:text-white">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pt-2">
                    <button id="save-schedule-btn" class="w-full bg-blue-500 text-white font-semibold py-2 px-3 rounded-lg text-sm">Agendar Fila</button>
                    <button id="restart-queue-btn" class="w-full bg-red-500 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Reiniciar Fila</button>
                    <button id="clear-chat-btn" class="w-full bg-orange-500 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-colors col-span-1 sm:col-span-2">Limpar Chat</button>
                </div>
            </div>
            
            <div id="driver-panel" class="hidden bg-cyan-100 dark:bg-cyan-800/20 p-5 rounded-2xl space-y-3">
                <h2 class="text-lg font-bold text-center text-cyan-800 dark:text-cyan-300">Painel do Motorista</h2>
                <button id="share-location-btn" class="w-full bg-cyan-500 text-white font-semibold py-2 px-3 rounded-lg text-sm">Compartilhar Localiza√ß√£o</button>
            </div>


            <div class="bg-violet-500 text-white p-6 rounded-3xl shadow-lg shadow-violet-500/30 flex flex-col">
              <div class="flex w-full justify-between items-center">
                <div>
                    <p class="text-violet-200 text-sm">Sua Posi√ß√£o</p>
                    <p id="user-position" class="text-5xl font-extrabold">-</p>
                </div>
                <div class="text-right">
                    <p class="text-violet-200 text-sm">Total na Fila</p>
                    <p id="total-in-queue" class="text-3xl font-bold">0</p>
                </div>
              </div>
              <div>
                <p id="users-next" class="text-lg font-bold"></p>
              </div>
            </div>
            
            <div id="chat-section" class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
                <h3 class="text-lg font-bold text-center text-slate-800 dark:text-white mb-3">Chat da Fila</h3>
                <div id="chat-messages" class="h-64 overflow-y-auto space-y-4 p-2 bg-slate-100 dark:bg-slate-900/50 rounded-lg mb-3"></div>
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Digite uma mensagem..." class="flex-grow bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-lg py-2 px-3 text-sm" autocomplete="off">
                    <button type="submit" id="send-chat-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Enviar</button>
                </form>
            </div>

            <div id="queue-status-card" class="text-center p-4 rounded-2xl">
                <p id="queue-status-message" class="font-semibold"></p>
            </div>

            <div id="observation-section" class="hidden bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-3">
                <label for="userObservation" class="block font-semibold text-slate-700 dark:text-slate-200">Adicionar ou editar observa√ß√£o:</label>
                <div class="flex gap-2">
                    <input type="text" id="userObservation" placeholder="Ex: Estou em prova, chego em 10 min..." class="flex-grow bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-lg py-2 px-3 text-sm">
                    <button id="save-observation-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">Guardar</button>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Ordem da Fila</h3>
                <div id="queue-list" class="space-y-3"></div>
            </div>

             <footer class="text-center text-xs text-slate-500 dark:text-slate-400 pt-8">
                <p>Desenvolvido por Kleison Vitoriano da Silva</p>
            </footer>
        </div>

        <div id="bottom-bar" class="hidden fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-t border-slate-200 dark:border-slate-800 z-30">
             <div class="max-w-md mx-auto">
                <button id="join-leave-btn" class="w-full font-bold py-4 px-4 rounded-2xl transition-all duration-300"></button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="join-queue-modal" class="hidden modal-overlay">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl w-full max-w-sm space-y-4 fade-in">
            <h3 class="text-lg font-bold text-center">Entrar em uma Fila</h3>
            <input type="text" id="queue-code-input" placeholder="Insira o c√≥digo da fila" class="w-full text-center tracking-widest font-mono uppercase bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4">
            <div class="grid grid-cols-2 gap-2">
                <button id="cancel-join-queue" class="w-full bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-3 rounded-lg">Cancelar</button>
                <button id="confirm-join-queue" class="w-full bg-indigo-500 text-white font-semibold py-2 px-3 rounded-lg">Entrar</button>
            </div>
        </div>
    </div>
    <div id="create-queue-modal" class="hidden modal-overlay">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl w-full max-w-sm space-y-4 fade-in">
            <h3 class="text-lg font-bold text-center">Criar Nova Fila</h3>
            <input type="text" id="queue-name-input" placeholder="Nome da nova fila" class="w-full bg-slate-100 text-slate-900 dark:bg-slate-700 dark:text-white border-transparent rounded-xl py-3 px-4">
            <div class="grid grid-cols-2 gap-2">
                <button id="cancel-create-queue" class="w-full bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-3 rounded-lg">Cancelar</button>
                <button id="confirm-create-queue" class="w-full bg-indigo-500 text-white font-semibold py-2 px-3 rounded-lg">Criar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
            setPersistence, browserLocalPersistence, browserSessionPersistence,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, onSnapshot, query, writeBatch, addDoc, serverTimestamp, getDocs, orderBy, limit, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Configura√ß√£o Firebase e Vari√°veis Globais ---
        const firebaseConfig = {
          apiKey: "AIzaSyDRf7ZciyvbJkX-P5cfWkzfI2Uw11Lxy0Q",
          authDomain: "filaonibus.firebaseapp.com",
          projectId: "filaonibus",
          storageBucket: "filaonibus.appspot.com",
          messagingSenderId: "93496874568",
          appId: "1:93496874568:web:52b127aa7d70dc8471aa7d",
          measurementId: "G-JRVSB40BDJ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const el = (id) => document.getElementById(id);
        const loadingSection = el('loading-section'), authOverlay = el('auth-overlay'),
              profileOverlay = el('profile-overlay'), mainContent = el('main-content'),
              bottomBar = el('bottom-bar'), queueSelectionScreen = el('queue-selection-screen');
        
        let currentUser = null;
        let userProfile = null;
        let currentQueueId = null;
        const SUPER_ADMIN_UID = ["twqMzdcSPVT31cuQJKsE8HKxQBH3","fezXWTgqXUMCUBUKSBau6Sv4K9n2"]; // Manter o seu UID de super admin aqui

        let unsubscribeQueue, unsubscribeChat;
        let leaveConfirmationTimeout;
        
        function cleanupRealtimeListeners() {
            if (unsubscribeQueue) unsubscribeQueue();
            if (unsubscribeChat) unsubscribeChat();
        }

        function showToast(message, type = 'info') {
            const toast = el('toast');
            toast.textContent = message;
            toast.className = `show ${type}`;
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }
        
        // --- Gest√£o de Ecr√£s ---
        function showScreen(screen) {
            const screens = [authOverlay, profileOverlay, mainContent, bottomBar, queueSelectionScreen];
            screens.forEach(s => s.classList.add('hidden'));
            authOverlay.style.display = 'none'; // reset flex display
            profileOverlay.style.display = 'none';

            if (screen === 'auth') authOverlay.style.display = 'flex';
            else if (screen === 'profile') profileOverlay.style.display = 'block';
            else if (screen === 'main') {
                mainContent.classList.remove('hidden');
                bottomBar.classList.remove('hidden');
            } else if (screen === 'queueSelection') {
                queueSelectionScreen.classList.remove('hidden');
            }
        }
        
        // --- FLUXO DE AUTENTICA√á√ÉO E PERFIL ---
        onAuthStateChanged(auth, async (user) => {
            cleanupRealtimeListeners();
            currentQueueId = null;
            try {
                currentUser = user;
                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        userProfile = { uid: user.uid, ...userDocSnap.data() };

                        if (SUPER_ADMIN_UID.includes(user.uid) && userProfile.role !== 'superadmin') {
                            try {
                                await updateDoc(userDocRef, { role: 'superadmin' });
                                userProfile.role = 'superadmin'; 
                            } catch (error) {
                                console.warn("Could not update role to Super Admin in Firestore.", error.message);
                                userProfile.role = 'superadmin';
                            }
                        }

                        if (userProfile.name) {
                            const lastQueueId = localStorage.getItem('lastQueueId');
                            if (lastQueueId && (userProfile.joinedQueues || []).includes(lastQueueId)) {
                                enterQueue(lastQueueId);
                            } else {
                                showScreen('queueSelection');
                                renderQueueSelectionScreen();
                            }
                        } else {
                            openProfileScreen(true);
                        }
                    } else { // Novo usu√°rio
                         const profileData = { email: user.email, role: 'user' };
                         if (SUPER_ADMIN_UID.includes(user.uid)) {
                             profileData.role = 'superadmin';
                         }
                         await setDoc(userDocRef, profileData);
                         userProfile = { uid: user.uid, ...profileData };
                         openProfileScreen(true);
                    }
                } else {
                    userProfile = null;
                    localStorage.removeItem('lastQueueId');
                    showScreen('auth');
                }
            } catch (error) {
                console.error("Erro na verifica√ß√£o de autentica√ß√£o:", error);
                showToast("Erro ao verificar a sua sess√£o.", "error");
                showScreen('auth');
            } finally {
                loadingSection.style.display = 'none';
            }
        });
        
        async function handleLogin() {
            const btn = el('login-btn');
            btn.disabled = true; btn.textContent = "A entrar...";
            el('auth-error').textContent = '';
            try {
                const persistence = el('rememberMe').checked ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistence);
                await signInWithEmailAndPassword(auth, el('loginEmail').value, el('loginPassword').value);
            } catch (error) {
                el('auth-error').textContent = "E-mail ou palavra-passe inv√°lidos.";
            } finally {
                btn.disabled = false; btn.textContent = "Entrar";
            }
        }

        async function handleRegister() {
            const btn = el('register-btn');
            const errorP = el('auth-error');
            const password = el('registerPassword').value;
            if (password !== el('registerPasswordConfirm').value) {
                errorP.textContent = 'As palavras-passe n√£o coincidem.'; return;
            }
            btn.disabled = true; btn.textContent = "A criar..."; errorP.textContent = '';
            try {
                await createUserWithEmailAndPassword(auth, el('registerEmail').value, password);
            } catch (error) {
                errorP.textContent = error.code === 'auth/weak-password' ? 'A senha deve ter pelo menos 6 caracteres.' : 'Ocorreu um erro ao registar.';
            } finally {
                btn.disabled = false; btn.textContent = "Criar Conta";
            }
        }
        
        async function handlePasswordReset() {
            const btn = el('send-reset-email-btn');
            const email = el('resetEmail').value;
            if (!email) { showToast("Por favor, insira o seu e-mail.", "error"); return; }
            btn.disabled = true; btn.textContent = "A enviar...";
            try {
                await sendPasswordResetEmail(auth, email);
                showToast("E-mail de recupera√ß√£o enviado!", "success");
            } catch (error) {
                showToast("N√£o foi poss√≠vel enviar o e-mail.", "error");
            } finally {
                btn.disabled = false; btn.textContent = "Enviar E-mail";
            }
        }

        function openProfileScreen(isInitialSetup = false) {
            el('profile-title').textContent = isInitialSetup ? "Complete o seu Perfil" : "Editar Perfil";
            el('close-profile-btn').style.display = isInitialSetup ? 'none' : 'block';
            el('userName').value = userProfile?.name || '';
            el('userCourse').value = userProfile?.course || '';
            el('userPhone').value = userProfile?.phone || '';
            el('profile-pic-preview').src = userProfile?.photoUrl || `https://placehold.co/128x128/a5b4fc/1e293b?text=${(userProfile?.name || '?').charAt(0).toUpperCase()}&font=inter`;
            showScreen('profile');
        }

        async function handleSaveProfile() {
            const btn = el('save-profile-btn');
            const userName = el('userName').value.trim();
            const userCourse = el('userCourse').value.trim();
            if (!userName || !userCourse) {
                showToast("Nome e curso s√£o obrigat√≥rios.", "error"); return;
            }
            btn.disabled = true; btn.textContent = 'A guardar...';
            try {
                const initial = userName.charAt(0).toUpperCase();
                const color = ['fca5a5', 'fdba74', '86efac', '67e8f9', 'a5b4fc', 'f0abfc'][Math.floor(Math.random() * 6)];
                const newPhotoUrl = `https://placehold.co/96x96/${color}/1e293b?text=${initial}&font=inter`;

                const profileData = { 
                    name: userName, 
                    course: userCourse, 
                    phone: el('userPhone').value.trim(),
                    photoUrl: newPhotoUrl
                };

                await updateDoc(doc(db, "users", currentUser.uid), profileData);
                userProfile = { ...userProfile, ...profileData };

                showToast("Perfil guardado com sucesso!", "success");
                
                if (currentQueueId) {
                    const memberDocRef = doc(db, "queues", currentQueueId, "members", currentUser.uid);
                    const memberDocSnap = await getDoc(memberDocRef);
                    if (memberDocSnap.exists()) {
                         await updateDoc(memberDocRef, { 
                             name: profileData.name, 
                             course: profileData.course,
                             photoUrl: profileData.photoUrl
                         });
                    }
                    showScreen('main');
                    renderHeader();
                } else {
                    showScreen('queueSelection');
                    renderQueueSelectionScreen();
                }
            } catch (error) {
                console.error("Erro ao guardar perfil:", error);
                showToast("N√£o foi poss√≠vel guardar o perfil.", "error");
            } finally {
                btn.disabled = false; btn.textContent = 'Guardar Altera√ß√µes';
            }
        }

        // --- GEST√ÉO DE FILAS (SELE√á√ÉO, CRIA√á√ÉO, JOIN) ---
        async function renderQueueSelectionScreen() {
             const listEl = el('queues-list');
             listEl.innerHTML = '<div class="text-center p-4">A carregar filas...</div>';
             
             el('create-new-queue-btn').classList.toggle('hidden', userProfile.role !== 'superadmin');

             if (!userProfile.joinedQueues || userProfile.joinedQueues.length === 0) {
                 listEl.innerHTML = '<div class="text-center text-slate-500 p-4">Ainda n√£o est√° em nenhuma fila. Entre com um c√≥digo ou crie uma (se for super admin).</div>';
                 return;
             }

             try {
                const queuePromises = userProfile.joinedQueues.map(id => getDoc(doc(db, "queues", id)));
                const queueDocs = await Promise.all(queuePromises);

                const queues = queueDocs.filter(d => d.exists()).map(d => ({id: d.id, ...d.data()}));
                
                listEl.innerHTML = queues.length > 0 ? queues.map(q => `
                    <div data-queue-id="${q.id}" class="queue-card-selector bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <h3 class="font-bold text-lg">${q.name}</h3>
                        <p class="text-sm text-slate-500">C√≥digo: ${q.code}</p>
                    </div>
                `).join('') : '<div class="text-center text-slate-500 p-4">Nenhuma fila encontrada.</div>';

                document.querySelectorAll('.queue-card-selector').forEach(card => {
                    card.addEventListener('click', () => enterQueue(card.dataset.queueId));
                });
             } catch(error) {
                console.error("Error loading queues:", error);
                listEl.innerHTML = '<div class="text-center text-red-500 p-4">N√£o foi poss√≠vel carregar as filas.</div>';
             }
        }
        
        async function enterQueue(queueId) {
            try {
                localStorage.setItem('lastQueueId', queueId);
                const queueDoc = await getDoc(doc(db, "queues", queueId));
                if (!queueDoc.exists()) {
                    showToast("Esta fila n√£o existe mais.", "error");
                    localStorage.removeItem('lastQueueId');
                    const updatedJoinedQueues = (userProfile.joinedQueues || []).filter(id => id !== queueId);
                    await updateDoc(doc(db, "users", currentUser.uid), { joinedQueues: updatedJoinedQueues });
                    userProfile.joinedQueues = updatedJoinedQueues;
                    renderQueueSelectionScreen();
                    return;
                }
                currentQueueId = queueId;
                const queueData = queueDoc.data();
                el('header-queue-name').textContent = queueData.name;
                el('queue-code-display').textContent = queueData.code;
                showScreen('main');
                setupRealtimeListenersForQueue(queueId);
            } catch (error) {
                showToast("Erro ao entrar na fila.", "error");
            }
        }

        async function handleJoinQueueWithCode() {
            const code = el('queue-code-input').value.trim().toUpperCase();
            if (!code) return;
            
            try {
                const q = query(collection(db, "queues"), where("code", "==", code));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showToast("C√≥digo de fila inv√°lido.", "error");
                    return;
                }
                
                const queueDoc = querySnapshot.docs[0];
                const queueId = queueDoc.id;

                const updatedJoinedQueues = userProfile.joinedQueues || [];
                if (!updatedJoinedQueues.includes(queueId)) {
                    updatedJoinedQueues.push(queueId);
                    await updateDoc(doc(db, "users", currentUser.uid), { joinedQueues: updatedJoinedQueues });
                    userProfile.joinedQueues = updatedJoinedQueues;
                }
                
                el('join-queue-modal').classList.add('hidden');
                el('queue-code-input').value = '';
                showToast(`Entrou na fila: ${queueDoc.data().name}`, 'success');
                renderQueueSelectionScreen();
            } catch (error) {
                console.error("Error joining queue:", error);
                showToast("N√£o foi poss√≠vel entrar na fila.", "error");
            }
        }

        async function handleCreateQueue() {
            const name = el('queue-name-input').value.trim();
            if (!name) return;

            try {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const newQueueRef = await addDoc(collection(db, "queues"), {
                    name: name,
                    code: code,
                    openTime: "08:00",
                    closeTime: "17:00",
                    createdBy: currentUser.uid,
                });
                
                const updatedJoinedQueues = userProfile.joinedQueues || [];
                updatedJoinedQueues.push(newQueueRef.id);
                await updateDoc(doc(db, "users", currentUser.uid), { joinedQueues: updatedJoinedQueues });
                userProfile.joinedQueues = updatedJoinedQueues;

                el('create-queue-modal').classList.add('hidden');
                el('queue-name-input').value = '';
                showToast(`Fila "${name}" criada com sucesso!`, 'success');
                renderQueueSelectionScreen();
            } catch (error) {
                console.error("Error creating queue:", error);
                showToast("Erro ao criar fila.", "error");
            }
        }

        // --- L√ìGICA DA FILA (PRINCIPAL) ---
        function setupRealtimeListenersForQueue(queueId) {
            if (!currentUser) return;
            cleanupRealtimeListeners();
            
            const membersRef = collection(db, "queues", queueId, "members");
            unsubscribeQueue = onSnapshot(query(membersRef, orderBy("timestamp")), async (snapshot) => {
                const memberDocs = snapshot.docs;
                renderQueue(memberDocs.map(d => ({ ...d.data(), uid: d.id })));
            }, (error) => console.error("Error listening to queue members:", error));
            
            const queueSettingsRef = doc(db, "queues", queueId);
            onSnapshot(queueSettingsRef, (doc) => {
                updateQueueStatusUI(doc.exists() ? doc.data() : null);
            }, (error) => console.error("Error listening to queue settings:", error));

            const chatRef = collection(db, "queues", queueId, "chat");
            unsubscribeChat = onSnapshot(query(chatRef, orderBy("timestamp", "desc"), limit(50)), (snapshot) => {
                const messages = snapshot.docs.map(d => d.data()).reverse();
                renderChat(messages);
            }, (error) => console.error("Error listening to chat:", error));
            
            renderHeader();
        }
        
        function renderHeader() {
            el('header-user-avatar').src = userProfile.photoUrl || `https://placehold.co/96x96/a5b4fc/1e293b?text=${userProfile.name.charAt(0)}&font=inter`;
            el('super-admin-panel').classList.toggle('hidden', userProfile.role !== 'superadmin');
            el('driver-panel').classList.toggle('hidden', userProfile.role !== 'driver');
        }

        function updateQueueStatusUI(settings) {
            const card = el('queue-status-card'), statusEl = el('queue-status-message');
            card.style.visibility = 'visible';

            if (!settings?.openTime || !settings?.closeTime) {
                statusEl.textContent = "A fila ainda n√£o foi agendada.";
                card.className = "text-center p-4 rounded-2xl bg-slate-200 dark:bg-slate-800";
                return;
            }
            
            el('queueOpenTime').value = settings.openTime;
            el('queueCloseTime').value = settings.closeTime;

            const now = new Date();
            const [openHour, openMinute] = settings.openTime.split(':').map(Number);
            const [closeHour, closeMinute] = settings.closeTime.split(':').map(Number);
            
            const openTime = new Date(); openTime.setHours(openHour, openMinute, 0, 0);
            const closeTime = new Date(); closeTime.setHours(closeHour, closeMinute, 0, 0);

            const formatTime = (date) => date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            if (now < openTime) {
                statusEl.textContent = `Fila fechada. Abrir√° √†s ${formatTime(openTime)}.`;
                card.className = "text-center p-4 rounded-2xl bg-sky-100 dark:bg-sky-900/50 text-sky-800 dark:text-sky-200";
            } else if (now >= openTime && now < closeTime) {
                statusEl.textContent = `Fila aberta! Fecha √†s ${formatTime(closeTime)}.`;
                card.className = "text-center p-4 rounded-2xl bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200";
            } else { 
                statusEl.textContent = "A fila foi encerrada.";
                card.className = "text-center p-4 rounded-2xl bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200";
            }
        }
        
        async function queueIsOpen() {
            try {
                if (!currentQueueId) return false;
                const settingsDoc = await getDoc(doc(db, "queues", currentQueueId));
                const settings = settingsDoc.exists() ? settingsDoc.data() : null;
                if (!settings || !settings.openTime || !settings.closeTime) return false;

                const now = new Date();
                const [openHour, openMinute] = settings.openTime.split(':').map(Number);
                const [closeHour, closeMinute] = settings.closeTime.split(':').map(Number);
                
                const openTime = new Date(); openTime.setHours(openHour, openMinute, 0, 0);
                const closeTime = new Date(); closeTime.setHours(closeHour, closeMinute, 0, 0);

                return now >= openTime && now <= closeTime;
            } catch (error) {
                console.error("Could not check if queue is open:", error);
                return false;
            }
        }

        async function handleJoinQueue() {
            if (!await queueIsOpen()) {
                showToast("A fila est√° fechada.", "error"); return;
            }
            const userQueueRef = doc(db, "queues", currentQueueId, "members", currentUser.uid);
            try {
                const { name, course, photoUrl, uid } = userProfile;
                await setDoc(userQueueRef, { name, course, photoUrl, uid, timestamp: Timestamp.now(), observation: "" });
            } catch(error) {
                console.error(error);
                showToast("N√£o foi poss√≠vel entrar na fila.", "error");
            }
        }

        async function handleLeaveQueue() {
            const userQueueRef = doc(db, "queues", currentQueueId, "members", currentUser.uid);
            const leaveBtn = el('header-leave-queue-btn');

            if (leaveBtn.dataset.confirming === 'true') {
                clearTimeout(leaveConfirmationTimeout);
                try {
                    await deleteDoc(userQueueRef);
                    delete leaveBtn.dataset.confirming;
                } catch (error) { showToast("Erro ao sair da fila.", "error"); }
            } else {
                leaveBtn.dataset.confirming = 'true';
                leaveBtn.textContent = "Certeza?";
                leaveBtn.className = `bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-xl transition-all text-sm`;
                leaveConfirmationTimeout = setTimeout(() => {
                    delete leaveBtn.dataset.confirming;
                    leaveBtn.textContent = "Sair";
                    leaveBtn.className = "bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition-all text-sm";
                }, 4000);
            }
        }
        
        async function renderQueue(queue) {
            const isOpen = await queueIsOpen();
            const joinBtn = el('join-leave-btn');
            const leaveBtn = el('header-leave-queue-btn');
            const userIndex = queue.findIndex(p => p.uid === currentUser.uid);
            const isInQueue = userIndex !== -1;

            el('total-in-queue').textContent = queue.length;
            el('user-position').textContent = isInQueue ? userIndex + 1 : "-";
            el('users-next').textContent = isInQueue ? (userIndex > 0 ? `Atr√°s de: ${queue[userIndex - 1].name.split(" ")[0]}` : "Voc√™ √© o primeiro!") : '-';

            if (isInQueue) {
                joinBtn.classList.add('hidden');
                leaveBtn.classList.remove('hidden');
                if (leaveBtn.dataset.confirming !== 'true') {
                     leaveBtn.textContent = "Sair";
                     leaveBtn.className = "bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition-all text-sm";
                }
                leaveBtn.onclick = handleLeaveQueue;
            } else {
                joinBtn.classList.remove('hidden');
                leaveBtn.classList.add('hidden');
                joinBtn.textContent = "Entrar na Fila";
                joinBtn.className = `w-full font-bold py-4 px-4 rounded-2xl transition-all bg-slate-800 dark:bg-white text-white dark:text-black`;
                joinBtn.disabled = !isOpen;
                if(isOpen){
                    randomButtonPos();
                }
                if(joinBtn.disabled) joinBtn.textContent = "Fila Fechada";
                joinBtn.onclick = handleJoinQueue;
            }

            el('queue-list').innerHTML = queue.length === 0 
                ? `<div class="text-center text-slate-500 py-8">A fila est√° vazia.</div>`
                : queue.map((p, i) => {
                    const isMe = p.uid === currentUser.uid;
                    const border = isMe ? 'border-4 border-violet-500' : 'border-4 border-transparent';
                    const obsHTML = p.observation ? `<p class="text-xs text-slate-500 mt-1 italic">üí¨ "${p.observation}"</p>` : '';
                    
                    let adminControlsHTML = '';
                    if (userProfile.role === 'superadmin' && !isMe) {
                        adminControlsHTML = `
                        <div class="flex-shrink-0 flex flex-col gap-2 items-center">
                            <div class="flex gap-2">
                                <button class="move-queue-btn text-slate-400 hover:text-green-500" data-uid="${p.uid}" data-direction="up">‚ñ≤</button>
                                <button class="delete-queue-btn text-slate-400 hover:text-red-500" data-uid="${p.uid}">‚úñ</button>
                                <button class="move-queue-btn text-slate-400 hover:text-yellow-500" data-uid="${p.uid}" data-direction="down">‚ñº</button>
                            </div>
                        </div>`;
                    }

                    return `<div class="bg-white dark:bg-slate-800 p-3 rounded-2xl flex items-center gap-4 shadow-sm ${border}">
                        <div class="bg-slate-200 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center font-bold text-lg flex-shrink-0">${i + 1}</div>
                        <img src="${p.photoUrl}" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-grow min-w-0">
                            <p class="font-semibold truncate">${p.name}</p>
                            <p class="text-sm text-slate-500">${p.course}</p>
                            ${obsHTML}
                        </div>
                        ${adminControlsHTML}
                    </div>`;
                }).join('');
                
            el('observation-section').style.display = isInQueue ? 'block' : 'none';
            if(isInQueue) el('userObservation').value = queue[userIndex]?.observation || '';
            
            // Re-attach event listeners
            document.querySelectorAll('.delete-queue-btn').forEach(b => b.addEventListener('click', (e) => handleDeleteFromQueue(e.currentTarget)));
            document.querySelectorAll('.move-queue-btn').forEach(b => b.addEventListener('click', () => handleMoveInQueue(b.dataset.uid, b.dataset.direction, queue)));
        }

        // --- A√á√ïES DE SUPER ADMIN E OUTROS ---
        let deleteConfirmationTimeouts = {};
        async function handleDeleteFromQueue(button) {
            const uid = button.dataset.uid;
            if (button.dataset.confirming) {
                clearTimeout(deleteConfirmationTimeouts[uid]);
                delete deleteConfirmationTimeouts[uid];
                try {
                    await deleteDoc(doc(db, "queues", currentQueueId, "members", uid));
                    showToast("Usu√°rio removido da fila.", "info");
                } catch (error) { showToast("Erro ao remover usu√°rio.", "error"); }
            } else {
                document.querySelectorAll('.delete-queue-btn[data-confirming="true"]').forEach(b => {
                    delete b.dataset.confirming; b.innerHTML = '‚úñ'; b.classList.remove('text-yellow-500');
                    clearTimeout(deleteConfirmationTimeouts[b.dataset.uid]);
                });
                button.dataset.confirming = 'true';
                button.innerHTML = '‚úî';
                button.classList.add('text-yellow-500');
                deleteConfirmationTimeouts[uid] = setTimeout(() => {
                    if (button.dataset.confirming) {
                        delete button.dataset.confirming; button.innerHTML = '‚úñ'; button.classList.remove('text-yellow-500');
                    }
                }, 4000);
            }
        }

        async function handleMoveInQueue(uid, direction, queue) {
            const userIndex = queue.findIndex(u => u.uid === uid);
            if (userIndex === -1) return;
            let swapIndex;
            if (direction === 'up' && userIndex > 0) swapIndex = userIndex - 1;
            else if (direction === 'down' && userIndex < queue.length - 1) swapIndex = userIndex + 1;
            else return;

            const userToMove = queue[userIndex];
            const userToSwapWith = queue[swapIndex];
            
            const batch = writeBatch(db);
            batch.update(doc(db, "queues", currentQueueId, "members", userToMove.uid), { timestamp: userToSwapWith.timestamp });
            batch.update(doc(db, "queues", currentQueueId, "members", userToSwapWith.uid), { timestamp: userToMove.timestamp });
            try { await batch.commit(); showToast("Usu√°rio movido.", "info"); } 
            catch(error) { showToast("Erro ao mover usu√°rio.", "error"); }
        }
        
        async function handleShareLocation() {
            if (!navigator.geolocation) { showToast("Geolocaliza√ß√£o n√£o √© suportada.", "error"); return; }
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                try {
                    await setDoc(doc(db, "locations", currentUser.uid), { lat: latitude, lng: longitude, timestamp: serverTimestamp(), driverName: userProfile.name }, { merge: true });
                    showToast("Localiza√ß√£o compartilhada!", "success");
                } catch(error) { showToast("N√£o foi poss√≠vel compartilhar a localiza√ß√£o.", "error"); }
            }, () => { showToast("N√£o foi poss√≠vel obter a sua localiza√ß√£o.", "error"); });
        }
        
        async function handleSendMessage(e) {
            e.preventDefault();
            const input = el('chat-input'); const text = input.value.trim();
            if (text) {
                input.value = '';
                try {
                    await addDoc(collection(db, "queues", currentQueueId, "chat"), { text, userName: userProfile.name, userPhotoUrl: userProfile.photoUrl, uid: currentUser.uid, timestamp: serverTimestamp() });
                } catch (error) { input.value = text; showToast("N√£o foi poss√≠vel enviar a mensagem.", "error"); }
            }
        }
        
        function renderChat(messages) {
            const chatEl = el('chat-messages');
            chatEl.innerHTML = messages.map(msg => {
                const isMe = msg.uid === currentUser.uid;
                const time = msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                return `
                    <div class="flex items-start gap-2.5 ${isMe ? 'justify-end' : ''}">
                        <img class="w-8 h-8 rounded-full object-cover ${isMe ? 'order-2' : 'order-1'}" src="${msg.userPhotoUrl}" alt="${msg.userName}">
                        <div class="flex flex-col gap-1 ${isMe ? 'order-1 items-end' : 'order-2 items-start'}">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold text-slate-900 dark:text-white">${isMe ? 'Voc√™' : msg.userName.split(' ')[0]}</span>
                                <span class="text-xs font-normal text-slate-500 dark:text-slate-400">${time}</span>
                            </div>
                            <div class="leading-snug p-3 rounded-xl ${isMe ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-slate-200 dark:bg-slate-700 rounded-bl-none'}">
                                <p class="text-sm font-normal">${msg.text}</p>
                            </div>
                        </div>
                    </div>`;
            }).join('');
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        async function saveObservation() {
            try { await updateDoc(doc(db, "queues", currentQueueId, "members", currentUser.uid), { observation: el('userObservation').value.trim() }); showToast("Observa√ß√£o guardada.", "success"); } 
            catch (error) { showToast("N√£o foi poss√≠vel guardar a observa√ß√£o.", "error"); }
        }

        // --- SETUP DE EVENTOS ---
        function setupEventListeners() {
            el('login-btn').addEventListener('click', handleLogin);
            el('register-btn').addEventListener('click', handleRegister);
            el('send-reset-email-btn').addEventListener('click', handlePasswordReset);
            el('main-logout-btn').addEventListener('click', () => {
                localStorage.removeItem('lastQueueId');
                signOut(auth);
            });
            el('edit-profile-btn').addEventListener('click', () => openProfileScreen(false));
            el('close-profile-btn').addEventListener('click', () => showScreen(currentQueueId ? 'main' : 'queueSelection'));
            el('save-profile-btn').addEventListener('click', handleSaveProfile);
            el('join-new-queue-btn').onclick = () => el('join-queue-modal').classList.remove('hidden');
            el('create-new-queue-btn').onclick = () => el('create-queue-modal').classList.remove('hidden');
            el('back-to-selection-btn').onclick = () => { 
                localStorage.removeItem('lastQueueId');
                currentQueueId = null; 
                cleanupRealtimeListeners(); 
                showScreen('queueSelection'); 
                renderQueueSelectionScreen(); 
            };
            el('cancel-join-queue').onclick = () => el('join-queue-modal').classList.add('hidden');
            el('confirm-join-queue').onclick = handleJoinQueueWithCode;
            el('cancel-create-queue').onclick = () => el('create-queue-modal').classList.add('hidden');
            el('confirm-create-queue').onclick = handleCreateQueue;
            el('save-observation-btn').addEventListener('click', saveObservation);
            el('chat-form').addEventListener('submit', handleSendMessage);
            el('share-location-btn').addEventListener('click', handleShareLocation);
            el('save-schedule-btn').addEventListener('click', () => updateDoc(doc(db, "queues", currentQueueId), { openTime: el('queueOpenTime').value, closeTime: el('queueCloseTime').value }).then(() => showToast("Agendamento guardado!", "info")));
            
            const addConfirmation = (buttonId, actionFn, successMsg) => {
                const btn = el(buttonId);
                let timeout;
                const originalText = btn.textContent, originalClasses = btn.className;
                const confirmText = 'Tem certeza?', confirmClasses = originalClasses.replace(/bg-(red|orange)-500/, 'bg-yellow-500');

                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (btn.dataset.confirming) {
                        clearTimeout(timeout);
                        actionFn().then(() => showToast(successMsg, "info")).catch(err => showToast("Erro.", "error"));
                        delete btn.dataset.confirming;
                        btn.textContent = originalText; btn.className = originalClasses;
                    } else {
                        btn.dataset.confirming = true;
                        btn.textContent = confirmText; btn.className = confirmClasses;
                        timeout = setTimeout(() => {
                            delete btn.dataset.confirming;
                            btn.textContent = originalText; btn.className = originalClasses;
                        }, 4000);
                    }
                });
            };
            
            addConfirmation('restart-queue-btn', async () => {
                const snapshot = await getDocs(query(collection(db, "queues", currentQueueId, "members")));
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }, "Fila reiniciada.");
            addConfirmation('clear-chat-btn', async () => {
                const snapshot = await getDocs(query(collection(db, "queues", currentQueueId, "chat")));
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }, "Chat limpo.");

            // Tabs de Autentica√ß√£o
            const showLoginTab = el('show-login-tab'), showRegisterTab = el('show-register-tab');
            const loginForm = el('login-form'), registerForm = el('register-form'), resetForm = el('password-reset-form'), authTabs = el('auth-tabs');
            const setActiveTab = (activeTab) => {
                loginForm.classList.add('hidden'); registerForm.classList.add('hidden');
                resetForm.classList.add('hidden'); authTabs.classList.remove('hidden');
                el('auth-error').textContent = '';

                if (activeTab === 'login') {
                    loginForm.classList.remove('hidden');
                    showLoginTab.className = 'flex-1 pb-2 text-center font-semibold border-b-2 border-indigo-500 text-indigo-500';
                    showRegisterTab.className = 'flex-1 pb-2 text-center font-semibold text-slate-500 dark:text-slate-400';
                } else if (activeTab === 'register') {
                    registerForm.classList.remove('hidden');
                    showRegisterTab.className = 'flex-1 pb-2 text-center font-semibold border-b-2 border-indigo-500 text-indigo-500';
                    showLoginTab.className = 'flex-1 pb-2 text-center font-semibold text-slate-500 dark:text-slate-400';
                } else if (activeTab === 'reset') {
                    authTabs.classList.add('hidden');
                    resetForm.classList.remove('hidden');
                }
            };
            showLoginTab.addEventListener('click', () => setActiveTab('login'));
            showRegisterTab.addEventListener('click', () => setActiveTab('register'));
            el('forgot-password-link').addEventListener('click', () => setActiveTab('reset'));
            el('back-to-login-btn').addEventListener('click', () => setActiveTab('login'));
        }
        
        // --- INICIALIZA√á√ÉO ---
        if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        window.matchMedia?.('(prefers-color-scheme: dark)').addEventListener('change', e => document.documentElement.classList.toggle('dark', e.matches));
        setupEventListeners();

        function randomButtonPos(){
            const bottomBar = el('bottom-bar');
            const leftPos = Math.floor(Math.random() * (window.innerWidth-50));
            const topPos = Math.floor(Math.random() * (window.innerHeight - 40));
            console.log(leftPos, topPos);
            bottomBar.className = `absolute left-[${leftPos}px] top-[${topPos}px]`;
        }
    </script>
</body>
</html>

